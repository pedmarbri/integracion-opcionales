{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Resources": {
        "APIOpcionales": {
            "Type": "AWS::ApiGateway::RestApi",
            "Properties": {
                "Name": "APIOpcionales"
            },
        },
        "order": {
            "Type": "AWS::ApiGateway::Resource",
            "Properties": {
                "RestApiId": {
                    "Ref": "APIOpcionales"
                },
                "ParentId": {
                    "Fn::GetAtt": [
                        "APIOpcionales",
                        "RootResourceId"
                    ]
                },
                "PathPart": "order"
            }
        },
        "PostOrder": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "ApiKeyRequired": true,
                "AuthorizationType": "NONE",
                "HttpMethod": "POST",
                "ResourceId": {
                    "Ref": "order"
                },
                "RestApiId": {
                    "Ref": "APIOpcionales"
                },
                "RequestModels": {
                    "application/json": {
                        "Ref": "OrderModel"
                    }
                },
                "Integration": {
                    "IntegrationHttpMethod": "POST",
                    "PassthroughBehavior": "NEVER",
                    "Type": "AWS",
                    "RequestParameters": {
                        "integration.request.header.Content-Type": "'application/x-www-form-urlencoded'"
                    },
                    "IntegrationResponses": [
                        {
                            "ResponseTemplates": {
                                "application/json": "#set($inputRoot = $input.path('$')){\"messaage_id\": \"$inputRoot.SendMessageResponse.SendMessageResult.MessageId\"}"
                            },
                            "StatusCode": "200",
                            "SelectionPattern": ""
                        }
                    ],
                    "Uri": {
                        "Fn::Join": [
                            "",
                            [
                                "arn:aws:apigateway:", 
                                {"Ref": "AWS::Region"}, ":sqs:path//", 
                                {"Ref": "AWS::AccountId"},
                                {"Fn::GetAtt": ["JobQueue",  "QueueName"]}
                            ]
                        ]
                    }
                },
            },
        },
        "OrderModel": {
            "Type": "AWS::ApiGateway::Model",
            "Properties": {
                "RestApiId": {
                    "Ref": "APIOpcionales"
                },
                "ContentType": "application/json",
                "Schema": {
                    "title": "Order",
                    "type": "object",
                    "required": [
                        "order_id", "timestamp", "shipping_method", "sales_channel", "customer",
                        "totals", "billing_address", "shipping_address", "items","payment"
                    ],
                    "properties": {
                        "order_id": {
                            "type": "string"
                        },
                        "timestamp": {
                            "type": "string",
                            "format": "date-time"
                        },
                        "shipping_method": {
                            "type": "string"
                        },
                        "sales_channel": {
                            "type": "string"
                        },
                        "customer": {
                            "type": "object",
                            "required": [
                                "birth_date", "email", "first_name", "last_name", "id_type", 
                                "id_number", "gender"
                            ],
                            "properties": {
                                "birth_date": {
                                    "type": "string",
                                    "format": "date-time"
                                },
                                "email": {
                                    "type": "string",
                                    "format": "email"
                                },
                                "first_name": {
                                    "type": "string"
                                },
                                "last_name": {
                                    "type": "string"
                                },
                                "id_type": {
                                    "type": "string"
                                },
                                "id_number": {
                                    "type": "string"
                                },
                                "gender": {
                                    "type": "string"
                                }
                            }
                        },
                        "totals": {
                            "type": "object",
                            "required": [
                                "subtotal", "discount", "shipping", "finance_cost", 
                                "grand_total"
                            ],
                            "properties": {
                                "subtotal": {
                                    "type": "number",
                                    "minimum": 0
                                },
                                "discount": {
                                    "type": "number",
                                    "minimum": 0
                                },
                                "shipping": {
                                    "type": "number",
                                    "minimum": 0
                                },
                                "finance_cost": {
                                    "type": "number",
                                    "minimum": 0
                                },
                                "grand_total": {
                                    "type": "number",
                                    "minimum": 0
                                }
                            }
                        },
                        "billing_address": {
                            "type": "object",
                            "required": [
                                "country", "region", "city", "post_code", "street", "number", 
                                "first_name", "last_name", "email", "telephone"
                            ],
                            "properties": {
                                "country": {
                                    "type": "string"
                                },
                                "region": {
                                    "type": "string"
                                },
                                "city": {
                                    "type": "string"
                                },
                                "post_code": {
                                    "type": "string"
                                },
                                "street": {
                                    "type": "string"
                                },
                                "number": {
                                    "type": "integer"
                                },
                                "floor": {
                                    "type": "string"
                                },
                                "apartment": {
                                    "type": "string"
                                },
                                "first_name": {
                                    "type": "string"
                                },
                                "last_name": {
                                    "type": "string"
                                },
                                "email": {
                                    "type": "string",
                                    "format": "email"
                                },
                                "telephone": {
                                    "type": "string"
                                }
                            }
                        },
                        "shipping_address": {
                            "type": "object",
                            "required": [
                                "country", "region", "city", "post_code", "street", "number", 
                                "first_name", "last_name", "email", "telephone"
                            ],
                            "properties": {
                                "country": {
                                    "type": "string"
                                },
                                "region": {
                                    "type": "string"
                                },
                                "city": {
                                    "type": "string"
                                },
                                "post_code": {
                                    "type": "string"
                                },
                                "street": {
                                    "type": "string"
                                },
                                "number": {
                                    "type": "integer"
                                },
                                "floor": {
                                    "type": "string"
                                },
                                "apartment": {
                                    "type": "string"
                                },
                                "first_name": {
                                    "type": "string"
                                },
                                "last_name": {
                                    "type": "string"
                                },
                                "email": {
                                    "type": "string",
                                    "format": "email"
                                },
                                "telephone": {
                                    "type": "string"
                                }
                            }
                        },
                        "items": {
                            "type": "array",
                            "items": {
                                "type": "object",
                                "required": [
                                    "sku", "name", "qty", "weight", "row_weight", "list_price",
                                    "discount_percent", "discount_amount", "row_total"
                                ],
                                "properties": {
                                    "sku": {
                                        "type": "string"
                                    },
                                    "name": {
                                        "type": "string"
                                    },
                                    "qty": {
                                        "type": "number",
                                        "exclusiveMinimum": true,
                                        "minimum": 0
                                    },
                                    "weight": {
                                        "type": "number",
                                        "minimum": 0
                                    },
                                    "row_weight": {
                                        "type": "number",
                                        "minimum": 0
                                    },
                                    "list_price": {
                                        "type": "number",
                                        "exclusiveMinimum": true,
                                        "minimum": 0
                                    },
                                    "discount_percent": {
                                        "type": "number",
                                        "minimum": 0
                                    },
                                    "discount_amount": {
                                        "type": "number",
                                        "minimum": 0
                                    },
                                    "row_total": {
                                        "type": "number",
                                        "exclusiveMinimum": true,
                                        "minimum": 0
                                    }
                                }
                            },
                            "minItems": 1
                        },
                        "payment": {
                            "type": "object",
                            "required": ["method", "transaction_id"],
                            "properties": {
                                "method": {
                                    "type": "string"
                                },
                                "transaction_id": {
                                    "type": "string"
                                }
                            }
                        }
                    }
                }
            },
        },
        "JobQueue": {
            "Type": "AWS::SQS::Queue",
        },
    }
}
